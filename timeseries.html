<!DOCTYPE html>
<html lang="de" id="top">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Risikogebiete Deutschland</title>
    <meta content="" name="description">
    <meta content="COVID-19, RISIKO, DEUTSCHLAND" name="keywords">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">


    <!-- Bootstrap CSS -->
    <link href="assets/css/bootstrap/bootstrap.min.css" rel="stylesheet">

    <!-- Master CSS -->
    <link href="assets/css/main.css" rel="stylesheet">

    <!-- Projection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>

    <!-- D3 js-->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- HDF5 js-->
    <script src="https://cdn.jsdelivr.net/gh/usnistgov/jsfive@master/dist/hdf5.js"></script>

    <!-- Own utils-->
    <script src="assets/js/utils.js"></script>
</head>
<body>
<!-- Spinning loader -->
<div id="loader" class="center"></div>

<!-- Element for the map-->
<div id="map__container" style="width: 100%; height:100vh; margin: auto;" align="center"></div>

<!-- Slider for iterating days-->

<div id="inputs" style="width: max-content;">
    <div class="accordion active">
      <h5>Altersgruppen</h5> 
    </div>
    <div class="panel">
      <ul>
      <li class="radio-inline"><input id="total" type="radio" name="optradio" checked="">Alle</li>
      <li class="radio-inline"><input id="A00-A04" type="radio" name="optradio"><label for="A00-A04">A00-A04</label></li>
      <li class="radio-inline"><input id="A05-A14" type="radio" name="optradio"><label for="A05-A14">A05-A14</label></li>
      <li class="radio-inline"><input id="A15-A34" type="radio" name="optradio"><label for="A15-A34">A15-A34</label></li>
      <li class="radio-inline"><input id="A35-A59" type="radio" name="optradio"><label for="A35-A59">A35-A59</label></li>
      <li class="radio-inline"><input id="A60-A79" type="radio" name="optradio"><label for="A60-A79">A60-A79</label></li>
      <li class="radio-inline"><input id="A80+" type="radio" name="optradio"><label for="A80+">A80+</label></li>
      </ul>
    </div>
    <hr style="margin-top: 0.25em; margin-bottom: 0.25em;">
    <div class="accordion active">
      <h5>Datum</h5> 
    </div>
    <input type="range" step="86400" style="display: inline-block;" id="slider_days">
    <span id="date"></span>
    </div>
</div>

<div id="legend" style="width max-content;">
    <div class="accordion active">
      <h5>Fälle/100.000 EW</h5> 
    </div>
    <div class="accordion active">
      <h5>in der jeweiligen Altersgruppe</h5> 
    </div>
</div>

</body>
<script>

/* ------------------------------------------------------------
 *  Global variables
 * ------------------------------------------------------------ */
// Colormap
var classes = [25,50,100,200,500,1000,2000]
var colors = ['#15b01a', '#f0f921', '#fdb42f', '#ed7953', '#cb4679', '#9c179e', '#5c01a6', "#0d0887"];
var color = d3.scaleLinear()
    .domain(classes)
    .range(colors);

var legend = d3.select("#legend")
for (let i=0;i<classes.length;i++){
    if (i == 0) {text = " < " + classes[i];}
    else { 
            if (i == (classes.length-1)) text = " "+classes[i]+" >";
            else text = " "+classes[i]+" < "+classes[i+1];
        }
    div = legend.append("div");
    div.append("div").attr("class","color-box").style("background-color",colors[i]);
    div.append("span").text(text);
}

// Data
var svg, strides, incidence, weekly_cases, index, geojson, date, dt_idx;
var age_group = "total";
var formatDate = d3.timeFormat("%d.%m.%g");
var age_groups = ["A00-A04","A05-A14","A15-A34","A35-A59","A60-A79","A80+"];

// Setup tooltip div
var tooltip = d3.select("#map__container")
    .append("div")
    .style("position", "absolute")
    .style("visibility", "hidden")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "1px")
    .style("border-radius", "5px")
    .style("padding", "10px")
    .style("pointer-events", "none")
    .style("background-color", "rgba(200,200,200,0.8)")
    .style("font-size", "10px")
    .html("");

/* Draw the map to an div container with id "map__container"
*/ 
function setup_svgmap(){
    // Get window size
    let height = window.innerHeight;
    var width = window.innerWidth;
    // Create svg inside map container
    svg = d3
        .select("#map__container")
        .append("svg")
        .style("display", "block")
        .attr("width", width)
        .attr("height", height);

    // Define identity projection
    // Own projection is done beforehand (see data loading)
    let padding = 10;
    var projection = d3.geoIdentity().reflectY(true).fitHeight(height-padding*2,geojson);
    let translate = projection.translate();
    projection.translate([translate[0], translate[1] + padding]);

    var path = d3.geoPath(projection);

    // Draw the map as svg
    let map = svg.append("g")
    map.selectAll("path")
        .data(geojson.features)
        .enter()
        .append("path")
        .attr("d",path)
        .attr("fill", "white")
        .attr("stroke", "gray")
        .attr("stroke-width","0.8")
        .on("mouseover",mouseoverHandler)
        .on("mouseout",mouseoutHandler)
        .on("mousemove",mousemoveHandler)
  
    // Select initial data
    dates = Object.keys(index.date)
    start = dates[0]
    end = dates[dates.length - 1]
    d3.select("#slider_days").attr('min', start).attr('max',end).property("value",end).dispatch("input");

    inputs = document.querySelectorAll("input[type='radio']")
    for (input of inputs){
        input.onclick = function(e){
                age_group = e.target.id;
                triggerTransition();
            }
        }


    // Update svg width
    plot.attr("width",plot.node().getBBox().width);
    // Setup inputs to trigger transitions
    var inputs = document.querySelectorAll("input[type='radio']")
    for (input of inputs){
        input.onclick = function(e){
            age_group = e.target.id;
            triggerTransition();
        }
    }

    //Set viewbox
    svg.attr("viewBox", [0-width/2+svg.node().getBBox().width/2,0,width,height])

    // Set zoom handler
    const handleZoom = (e) => map.attr('transform', e.transform);
    const zoom = d3.zoom().on('zoom', handleZoom);
    d3.select('svg').call(zoom);
}

function mouseoverHandler(d){
    let this_ele = d3.select(this)

    // Save old color
    this_ele.attr("old_color",this_ele.attr("fill"));

    // Change color to lighter hue
    this_ele.attr("fill",pSBC(0.3,this_ele.attr("old_color")));

    tooltip.interrupt();
    tooltip.style("visibility", "visible");
    tooltip.html(tooltipText(this));
}
function mouseoutHandler(d){
    // Restore old color
    d3.select(this).attr("fill",d3.select(this).attr("old_color"));
    tooltip.transition().delay(1000).style("visibility", "hidden");
}

function mousemoveHandler(d){
    //console.log(d3.event.pageX,d3.event.pageY)
    r = tooltip.node().getBoundingClientRect();
    tooltip.style("left", (svg.node().getBoundingClientRect().left+d3.pointer(d,window)[0])+"px")
           .style("top",  (svg.node().getBoundingClientRect().top+d3.pointer(d,window)[1]-r.height)+"px");
}

function tooltipText(element){
    str = `
        <h5> ${element.__data__.properties["BEZ"]} ${element.__data__.properties["GEN"]} </h5>
        <hr>
        <table>
            <tr>
                <th style="text-align: left; padding-right:10px;">Altersgruppe</th>
                <th style="text-align: right;padding-left: 10px">Fälle der letzte Woche</th>
                <th style="text-align: right;padding-left: 10px">pro 100.000 EW</th>
            </tr>
        `;
    lk_idx = index["IdLandkreis"][parseInt(element.__data__.properties.AGS)] 
    ag_idx = index["Altersgruppe"]["total"];
    i = dt_idx * strides[0] + lk_idx * strides[1] + ag_idx * strides[2];
    str +=`
            <tr>
                <td>Alle</td>
                <td style="text-align: right;">${weekly_cases[i]}</td>
                <td style="text-align: right;">${incidence[i].toFixed(0)}</td>
            </tr>
        `;
    for (a of age_groups) {
        ag_idx = index["Altersgruppe"][a];
        i = dt_idx * strides[0] + lk_idx * strides[1] + ag_idx * strides[2];
        str +=`
            <tr>
                <td>${a}</td>
                <td style="text-align: right;">${weekly_cases[i]}</td>
                <td style="text-align: right;">${incidence[i].toFixed(0)}</td>
            </tr>
        `;    			
    }
    str += "</table>";
    return str;
}

/* Update geojsons data for timeseries plotting
*/
function update_geojson(date, age_group){
    dt_idx = index["date"][date];
    ag_idx = index["Altersgruppe"][age_group];
    i = dt_idx*strides[0]+ag_idx*strides[2]
    geojson.features.forEach(el => {
        const linkedData = incidence[index["IdLandkreis"][parseInt(el.properties.AGS)]*strides[1]+i];
        el.properties.index_data = linkedData;
    });
}

function triggerTransition(){
    update_geojson(date,age_group);
    d3.select("#date").html(formatDate(date*1000));
  
    let test = d3.select("svg")
        .selectAll("path")
        .attr("fill", d => {
            return color(d.properties.index_data)
        });
}    

//Add event to slider
document.getElementById("slider_days").addEventListener("input", throttle(function() {
    date = document.getElementById("slider_days").value;
    triggerTransition();
},0));

// Load geojson file and fetch timeseries
Promise.all([
    d3.json("assets/data/landkreise_edited.geojson")
        .then((r)=>{
            // Own projection
            project(
                r,
                '+proj=merc +lat_1=33 +lat_2=45 +lat_0=0 +lon_0=0'
            );
            return r
        }),
    d3.json("assets/data/array_index.json")
        .then((r)=>{
                index = r;
                return index
            }),
    fetch("assets/data/timeseries_nd.hdf5")
        .then((r)=>{
            return r.arrayBuffer()
        })
        .then((r)=>{
            return new hdf5.File(r)
        })
        .then((f)=>{
           incidence = f.get('data/incidence').value;
           weekly_cases = f.get('data/weekly_cases').value;
           strides = []
           s = 1
           f.get('data/incidence').shape.reverse().forEach(function(item) {strides.push(s);s=s*item;});
           strides = strides.reverse();
        })
]).then((data)=>{
    // Plotting setup
    geojson = data[0];
    setup_svgmap();
    document.getElementById("loader").style.display = "none";
});

window.addEventListener("resize", function(){
    let width_container = document.getElementById("map__container").clientWidth;
    let height_container = document.getElementById("map__container").clientHeight;
    d3.select("svg")
        .attr("width",width_container)
        .attr("height",(d) => height_container);
});

</script>
</html>
